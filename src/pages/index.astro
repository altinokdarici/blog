---
import { type CollectionEntry, getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import ArrowCard from "@components/ArrowCard.astro";
import Link from "@components/Link.astro";
import { HOME, SOCIALS } from "@consts";

const data = (await getCollection("blog"))
  .filter(post => !post.data.draft)
  .sort((a, b) => {
    const dateCompare = b.data.date.valueOf() - a.data.date.valueOf();
    if (dateCompare !== 0) return dateCompare;
    return a.slug.localeCompare(b.slug);
  });

type Acc = {
  [year: string]: CollectionEntry<"blog">[];
}

const posts = data.reduce((acc: Acc, post) => {
    const year = post.data.date.getFullYear().toString();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(post);
    return acc;
  }, {});

const years = Object.keys(posts).sort((a, b) => parseInt(b) - parseInt(a));
---

<PageLayout title={HOME.TITLE} description={HOME.DESCRIPTION}>
  <Container>
    <div class="space-y-10">
      <section class="animate">
        <p class="text-stone-900 dark:text-stone-100">
          I'm a Principal Software Engineer at Microsoft with 15+ years of experience across frontend, backend, and cloud infrastructure. I've built applications serving hundreds of millions of users and write about TypeScript, React, and the engineering practices I've learned solving hard technical problems at scale. If you're navigating similar challenges, <Link href={SOCIALS.find(s => s.NAME === "linkedin")?.HREF || ""} external>let's connect</Link>.
        </p>
      </section>

      <div class="space-y-4">
        {years.map(year => (
          <section class="animate space-y-4">
            <div class="font-semibold text-black dark:text-white">
              {year}
            </div>
            <div>
              <ul class="flex flex-col gap-4">
                {
                  posts[year].map((post) => (
                    <li>
                      <ArrowCard entry={post}/>
                    </li>
                  ))
                }
              </ul>
            </div>
          </section>
        ))}
      </div>
    </div>
  </Container>
</PageLayout>
